<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Advanced AI Expense Splitter</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f0f0; padding: 20px; }
    .container { max-width: 600px; background: white; margin: auto; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h1, h2 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px;}
    
    .input-area { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
    textarea { flex-grow: 1; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; min-height: 100px; }
    
    #mic-button { width: 50px; height: 50px; padding: 0; font-size: 24px; background: #4285F4; color: white; border: none; cursor: pointer; border-radius: 50%; flex-shrink: 0; }
    #mic-button.recording { background: #d9534f; }
    #mic-button:disabled { background: #ccc; cursor: not-allowed; }

    #split-button { width: 100%; padding: 15px; font-size: 16px; background: #34A853; color: white; border: none; cursor: pointer; font-weight: 600; border-radius: 8px; margin-bottom: 10px;}
    #split-button:disabled { background: #ccc; cursor: not-allowed;}
    
    /* âœ… FIX: Added styles for the "Add Expense" button */
    #add-expense-button {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        background: #007AFF; /* A distinct blue for the final action */
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        border-radius: 8px;
        margin-top: 20px; /* Added space above the button */
    }
    
    #result { margin-top: 20px; font-size: 16px; line-height: 1.6; }
    .details { background: #f9f9f9; border-left: 3px solid #34A853; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
    .details p { margin: 5px 0;}
    .details input[type="text"], .details input[type="date"] { width: calc(100% - 20px); padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #ddd; }
    #settlements { list-style-type: none; padding-left: 0; }
    #settlements li { background: #f0f0f0; padding: 10px; border-radius: 6px; margin-bottom: 8px; }
    .warning { color: #d9534f; font-size: 14px; text-align: center; margin-top: 10px;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Advanced AI Expense Splitter</h1>
    <div class="input-area">
      <textarea id="input" placeholder="Click the mic to speak, or type here... e.g., Yesterday I paid $120 for 'Team Lunch' group. Split it so I cover $80 and Jane covers $40."></textarea>
      <button id="mic-button" title="Record Expense">ðŸŽ¤</button>
    </div>
    <button id="split-button">Process Expense</button>
    <div id="result"></div>
  </div>

  <script>
    // --- The JavaScript logic remains the same ---
    const groqApiKey = "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";
    // ... (rest of your script)
    const splitButton = document.getElementById('split-button');
    const input = document.getElementById('input');
    const resultDiv = document.getElementById('result');
    const micButton = document.getElementById('mic-button');
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (window.SpeechRecognition) {
      recognition = new SpeechRecognition();
      let isRecording = false;
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';
      micButton.addEventListener('click', () => {
        if (isRecording) {
          recognition.stop();
        } else {
          input.value = '';
          recognition.start();
        }
      });
      recognition.onstart = () => { isRecording = true; micButton.classList.add('recording'); micButton.title = "Stop Recording"; };
      recognition.onend = () => { isRecording = false; micButton.classList.remove('recording'); micButton.title = "Record Expense"; };
      recognition.onresult = (event) => {
        let finalTranscript = ''; let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) { finalTranscript += event.results[i][0].transcript; } else { interimTranscript += event.results[i][0].transcript; }
        }
        input.value = finalTranscript + interimTranscript;
      };
      recognition.onerror = (event) => { console.error("Speech recognition error", event.error); micButton.title = `Error: ${event.error}. Try again.`; };
    } else {
      micButton.disabled = true;
      micButton.title = "Voice input is not supported in this browser. Please use Chrome or Edge.";
    }
    async function processExpense() {
        const inputText = input.value;
        if (!inputText) { resultDiv.innerHTML = `<p class="warning">Please enter an expense description.</p>`; return; }
        if (!groqApiKey || groqApiKey === "YOUR_GROQ_API_KEY") { resultDiv.innerHTML = `<p class="warning">Please enter your Groq API key in the script.</p>`; return; }
        splitButton.disabled = true; splitButton.textContent = 'Processing...'; resultDiv.innerHTML = '';
        const todaysDate = new Date().toISOString().slice(0, 10);
        const systemPrompt = `You are an expert expense parsing assistant. Your task is to extract details from a user's text and return ONLY a valid JSON object. The JSON must have the following keys: 1.  "amount": Total expense amount as a number. 2.  "payer": The person who paid. If the user says "I" or "me", use "You". Otherwise, use the name as given in the text (e.g., "ram paid" means payer is "ram"). 3.  "participants": An array of all people involved. If not specified, assume payer plus one other (e.g., "we" means payer and one friend). 4.  "reason": A brief description of the expense (e.g., "Dinner", "Movie Tickets"). Default to "General Expense" if not specified. 5.  "group": The name of the group, if mentioned (e.g., "Trip Fund", "Office Lunch"). Default to null if not specified. 6.  "date": The date of the expense in YYYY-MM-DD format. If not mentioned, use today's date: ${todaysDate}. 7.  "split_details": An object with two keys: "type": Should be "equally" or "unequally", and "distribution": An object where keys are participant names and values are their share of the cost. For an equal split, you must still calculate and list each person's share. Example for an unequal split: User input: "I paid $100 for tickets. Split it so I cover $60 and Ben covers $40." Your JSON output: {"amount": 100, "payer": "You", "participants": ["You", "Ben"], "reason": "Tickets", "group": null, "date": "${todaysDate}", "split_details": {"type": "unequally", "distribution": {"You": 60, "Ben": 40}}}`;
        try {
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${groqApiKey}` },
            body: JSON.stringify({ model: 'llama3-8b-8192', messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: inputText }], response_format: { type: "json_object" } }) });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            const data = await response.json();
            const parsedData = JSON.parse(data.choices[0].message.content);
            displaySettlement(parsedData);
        } catch (error) {
            resultDiv.innerHTML = `<p class="warning">Error: Could not process request. (${error.message})</p>`;
        } finally {
            splitButton.disabled = false;
            splitButton.textContent = 'Process Expense';
        }
    }
    function displaySettlement(data) {
        let { amount, payer, participants, reason, group, date, split_details } = data;
        if (!amount || !payer || !participants || !split_details) { resultDiv.innerHTML = `<p class="warning">The AI couldn't understand the expense. Please try phrasing it differently.</p>`; return; }
        const balances = {};
        participants.forEach(p => { balances[p] = 0; });
        balances[payer] += amount;
        for (const person in split_details.distribution) { if (balances.hasOwnProperty(person)) { balances[person] -= split_details.distribution[person]; } }
        const debtors = [], creditors = [];
        for (const person in balances) {
            if (balances[person] > 0.01) creditors.push({ person, amount: balances[person] });
            if (balances[person] < -0.01) debtors.push({ person, amount: -balances[person] });
        }
        let settlements = [];
        while (debtors.length > 0 && creditors.length > 0) {
            const debtor = debtors[0], creditor = creditors[0];
            const payment = Math.min(debtor.amount, creditor.amount);
            settlements.push(`${debtor.person} owes ${creditor.person} $${payment.toFixed(2)}`);
            debtor.amount -= payment; creditor.amount -= payment;
            if (debtor.amount < 0.01) debtors.shift();
            if (creditor.amount < 0.01) creditors.shift();
        }
        let output = `<div class="details"><p><strong>Reason:</strong> <input type="text" id="edit-reason" value="${reason}"></p><p><strong>Total:</strong> $<input type="text" id="edit-amount" value="${amount.toFixed(2)}"> | <strong>Paid by:</strong> <input type="text" id="edit-payer" value="${payer}"></p><p><strong>Date:</strong> <input type="date" id="edit-date" value="${date}"></p>${group ? `<p><strong>Group:</strong> <input type="text" id="edit-group" value="${group}"></p>` : `<p><strong>Group:</strong> <input type="text" id="edit-group" value=""></p>`}<p><strong>Split Type:</strong> ${split_details.type}</p></div><h2>Settlement</h2><ul id="settlements">${settlements.length > 0 ? settlements.map(s => `<li>${s}</li>`).join('') : '<li>All settled up!</li>'}</ul><button id="add-expense-button">Add Expense</button>`;
        resultDiv.innerHTML = output;
        document.getElementById('add-expense-button').addEventListener('click', () => {
            const editedData = { amount: parseFloat(document.getElementById('edit-amount').value), payer: document.getElementById('edit-payer').value, reason: document.getElementById('edit-reason').value, group: document.getElementById('edit-group').value || null, date: document.getElementById('edit-date').value, participants: participants, split_details: split_details };
            console.log("Expense Added:", editedData);
            alert("Expense added successfully (check console for details)!");
            input.value = '';
            resultDiv.innerHTML = '';
        });
    }
    splitButton.addEventListener('click', processExpense);
  </script>
</body>
</html>
